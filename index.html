<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>卒研クイズアプリ</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      --bg: #f5f7fb;
      --card: #ffffff;
      --accent: #1d72f3;
      --accent-soft: rgba(29,114,243,0.08);
      --danger: #ff6b81;
      --border: #dde3f0;
      --text-main: #222;
      --text-sub: #64748b;
      --radius-lg: 16px;
      --radius-pill: 999px;
      --shadow-soft: 0 12px 32px rgba(15,23,42,0.12);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 32px 12px 48px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #e0edff 0, #f5f7fb 45%, #f5f7fb 100%);
      color: var(--text-main);
    }

    .page {
      max-width: 1080px;
      margin: 0 auto;
      background: rgba(255,255,255,0.9);
      border-radius: 28px;
      box-shadow: var(--shadow-soft);
      padding: 20px 20px 28px;
      backdrop-filter: blur(16px);
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      padding: 6px 4px 14px;
      border-bottom: 1px solid rgba(148,163,184,0.35);
      margin-bottom: 10px;
    }

    .title-block h1 {
      margin: 0;
      font-size: 22px;
      letter-spacing: .03em;
    }
    .title-block p {
      margin: 2px 0 0;
      font-size: 12px;
      color: var(--text-sub);
    }

    .token-box {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 11px;
      color: var(--text-sub);
      min-width: 180px;
    }

    .token-box input {
      padding: 4px 8px;
      border-radius: 10px;
      border: 1px solid var(--border);
      font-size: 11px;
    }

    .tabs {
      display: inline-flex;
      background: #eef2ff;
      border-radius: var(--radius-pill);
      padding: 4px;
      gap: 4px;
    }

    .tab-btn {
      border: none;
      background: transparent;
      padding: 6px 18px;
      border-radius: var(--radius-pill);
      font-size: 13px;
      color: var(--text-sub);
      cursor: pointer;
      white-space: nowrap;
      transition: background .18s, color .18s, transform .12s;
    }
    .tab-btn.active {
      background: #fff;
      color: var(--accent);
      box-shadow: 0 2px 6px rgba(15,23,42,0.15);
      transform: translateY(-1px);
    }

    main {
      padding: 4px 2px 0;
    }

    .view {
      display: none;
    }
    .view.active {
      display: block;
    }

    /* --- クイズ作成タブ --- */
    .card {
      background: var(--card);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      padding: 16px 18px 18px;
      margin-bottom: 14px;
    }

    .card h2 {
      margin: 0 0 10px;
      font-size: 17px;
    }

    .field {
      margin-bottom: 10px;
    }

    .field label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 4px;
      color: var(--text-sub);
    }

    .field input[type="text"],
    .field textarea {
      width: 100%;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
      font-size: 13px;
      resize: vertical;
    }

    .field textarea {
      min-height: 60px;
    }

    .field small {
      font-size: 11px;
      color: var(--text-sub);
    }

    .actions-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-top: 4px;
    }

    .btn {
      border-radius: var(--radius-pill);
      border: none;
      padding: 7px 18px;
      font-size: 13px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: background .15s, transform .1s, box-shadow .15s;
    }

    .btn-primary {
      background: var(--accent);
      color: #fff;
      box-shadow: 0 4px 12px rgba(37,99,235,0.35);
    }
    .btn-primary:active {
      transform: translateY(1px);
      box-shadow: 0 1px 4px rgba(15,23,42,0.35);
    }

    .btn-soft {
      background: #f8fafc;
      color: var(--text-sub);
      border: 1px solid var(--border);
    }

    .btn-danger {
      background: var(--danger);
      color: #fff;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: var(--radius-pill);
      font-size: 11px;
      background: #e2e8f0;
      color: var(--text-sub);
      gap: 4px;
    }

    .chip-status-ok {
      background: #dcfce7;
      color: #15803d;
    }
    .chip-status-warn {
      background: #fee2e2;
      color: #b91c1c;
    }

    /* --- 単語帳（一覧） --- */
    .list-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 10px;
    }

    .filter-select {
      padding: 5px 10px;
      border-radius: var(--radius-pill);
      border: 1px solid var(--border);
      font-size: 12px;
      background: #fff;
    }

    .quiz-item {
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      background: #fff;
      padding: 10px 12px 10px;
      margin-bottom: 8px;
      display: grid;
      grid-template-columns: minmax(0, 1.6fr) minmax(0, 1.3fr) auto;
      gap: 10px;
      align-items: center;
    }

    .quiz-main {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .quiz-title {
      font-size: 14px;
      font-weight: 600;
    }

    .quiz-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      font-size: 11px;
      color: var(--text-sub);
    }

    .quiz-answer {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .quiz-answer input {
      width: 100%;
      padding: 6px 8px;
      border-radius: 10px;
      border: 1px solid var(--border);
      font-size: 13px;
    }

    .quiz-actions {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 6px;
    }

    .img-thumb {
      width: 120px;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      object-fit: cover;
      max-height: 80px;
      background: #f1f5f9;
    }

    .img-placeholder {
      width: 120px;
      height: 72px;
      border-radius: 10px;
      border: 1px dashed #cbd5f5;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      color: var(--text-sub);
      background: #f8fafc;
    }

    /* --- スライド --- */
    .slide-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }

    .slide-card {
      width: 100%;
      max-width: 520px;
      min-height: 220px;
      background: #fff;
      border-radius: 20px;
      border: 1px solid var(--border);
      padding: 16px 18px 18px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      box-shadow: 0 8px 24px rgba(15,23,42,0.12);
    }

    .slide-question {
      font-size: 18px;
      font-weight: 600;
    }

    .slide-answer {
      font-size: 16px;
      color: var(--text-sub);
    }

    .slide-image {
      max-width: 100%;
      max-height: 220px;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      object-fit: cover;
      background: #f1f5f9;
    }

    .slide-controls {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      width: 100%;
      max-width: 520px;
    }

    .slide-index {
      font-size: 12px;
      color: var(--text-sub);
    }

    .msg {
      font-size: 12px;
      color: var(--text-sub);
      margin-top: 4px;
    }

    @media (max-width: 720px) {
      .quiz-item {
        grid-template-columns: minmax(0,1fr);
      }
      .quiz-actions {
        align-items: stretch;
        flex-direction: row;
        justify-content: flex-end;
        flex-wrap: wrap;
      }
      .img-thumb,
      .img-placeholder {
        width: 100%;
      }
      header {
        flex-direction: column;
        align-items: flex-start;
      }
      .token-box {
        width: 100%;
      }
    }
  </style>
</head>

<body>
<div class="page">
  <header>
    <div class="title-block">
      <h1>卒研クイズアプリ</h1>
      <p>自作クイズ＋画像生成で語彙を覚える</p>
    </div>

    <div class="token-box">
      <span>API X-Token（開発用なら <code>dev</code> など）</span>
      <input id="x-token-input" type="text" placeholder="例: dev" />
    </div>

    <nav class="tabs">
      <button class="tab-btn active" data-view="create">クイズ作成</button>
      <button class="tab-btn" data-view="list">単語帳（一覧）</button>
      <button class="tab-btn" data-view="slides">単語帳（スライド）</button>
    </nav>
  </header>

  <main>
    <!-- クイズ作成 -->
    <section class="view active" id="view-create">
      <div class="card">
        <h2>クイズを追加</h2>
        <form id="create-quiz-form">
          <div class="field">
            <label for="create-question">問題文（例：appleの日本語は？）</label>
            <input id="create-question" type="text" required />
          </div>
          <div class="field">
            <label for="create-answer">正解（例：りんご）</label>
            <input id="create-answer" type="text" required />
          </div>
          <div class="field">
            <label for="create-note">メモ（任意）</label>
            <textarea id="create-note" placeholder="自分用メモ・解説など"></textarea>
          </div>
          <div class="actions-row">
            <button type="submit" class="btn btn-primary">クイズを保存</button>
            <span class="msg" id="create-status"></span>
          </div>
        </form>
      </div>
    </section>

    <!-- 単語帳（一覧） -->
    <section class="view" id="view-list">
      <div class="card">
        <div class="list-header">
          <div>
            <strong>単語帳（一覧）</strong>
            <div class="msg">答えを入力して「判定」。画像は必要に応じて生成 / 再生成します。</div>
          </div>
          <div style="display:flex; gap:6px; align-items:center;">
            <select id="filter-select" class="filter-select">
              <option value="all">すべて</option>
              <option value="unanswered">未回答のみ</option>
              <option value="incorrect_only">直近不正解のみ</option>
            </select>
            <button id="reload-list" class="btn btn-soft" type="button">再読み込み</button>
          </div>
        </div>

        <div id="quiz-list-container"></div>
        <div class="msg" id="list-status"></div>
      </div>
    </section>

    <!-- 単語帳（スライド） -->
    <section class="view" id="view-slides">
      <div class="card">
        <div class="slide-wrapper">
          <div class="slide-card" id="slide-card">
            <div class="slide-index" id="slide-index"></div>
            <div class="slide-question" id="slide-question"></div>
            <img class="slide-image" id="slide-image" alt="" style="display:none;" />
            <div class="slide-answer" id="slide-answer" style="display:none;"></div>
          </div>
          <div class="slide-controls">
            <button id="slide-toggle-answer" class="btn btn-soft" type="button">答えを表示</button>
            <button id="slide-next" class="btn btn-primary" type="button">次の問題へ</button>
          </div>
          <div class="msg" id="slide-status"></div>
        </div>
      </div>
    </section>
  </main>
</div>

<script>
(() => {
  "use strict";

  const API_BASE = ""; // 同一オリジン想定
  const tokenInput = document.getElementById("x-token-input");

  function buildHeaders() {
    const headers = { "Content-Type": "application/json" };
    const t = tokenInput.value.trim();
    if (t) headers["X-Token"] = t;
    return headers;
  }

  const tabs = document.querySelectorAll(".tab-btn");
  const views = {
    create: document.getElementById("view-create"),
    list: document.getElementById("view-list"),
    slides: document.getElementById("view-slides"),
  };

  tabs.forEach((btn) => {
    btn.addEventListener("click", () => {
      const v = btn.dataset.view;
      tabs.forEach((b) => b.classList.toggle("active", b === btn));
      Object.entries(views).forEach(([key, el]) => {
        el.classList.toggle("active", key === v);
      });
      if (v === "list") {
        loadQuizList();
      } else if (v === "slides") {
        ensureSlidesLoaded();
      }
    });
  });

  /* ---- クイズ作成 ---- */
  const createForm = document.getElementById("create-quiz-form");
  const createQuestion = document.getElementById("create-question");
  const createAnswer = document.getElementById("create-answer");
  const createNote = document.getElementById("create-note");
  const createStatus = document.getElementById("create-status");

  if (createForm) {
    createForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      createStatus.textContent = "保存中…";

      try {
        const body = {
          question: createQuestion.value.trim(),
          answer: createAnswer.value.trim(),
          note: createNote.value.trim() || null,
        };

        const res = await fetch(`${API_BASE}/quiz/create`, {
          method: "POST",
          headers: buildHeaders(),
          body: JSON.stringify(body),
        });

        if (!res.ok) {
          const t = await res.text();
          throw new Error(t || `HTTP ${res.status}`);
        }

        createForm.reset();
        createStatus.textContent = "保存しました！";
        setTimeout(() => (createStatus.textContent = ""), 2500);
      } catch (err) {
        console.error(err);
        createStatus.textContent = "保存に失敗しました";
      }
    });
  }

  /* ---- 単語帳（一覧） ---- */

  const listContainer = document.getElementById("quiz-list-container");
  const listStatus = document.getElementById("list-status");
  const filterSelect = document.getElementById("filter-select");
  const reloadListBtn = document.getElementById("reload-list");

  let cachedQuizzes = [];

  async function loadQuizList() {
    if (!listContainer) return;
    listContainer.innerHTML = "";
    listStatus.textContent = "読込中…";

    const status = filterSelect.value || "all";

    try {
      const res = await fetch(`${API_BASE}/quiz/list?status=${encodeURIComponent(status)}`, {
        headers: buildHeaders(),
      });

      if (!res.ok) {
        const txt = await res.text();
        throw new Error(txt || `HTTP ${res.status}`);
      }

      const data = await res.json();
      cachedQuizzes = Array.isArray(data) ? data : [];

      if (!cachedQuizzes.length) {
        listContainer.innerHTML = "<p class='msg'>クイズがまだありません。</p>";
        listStatus.textContent = "";
        return;
      }

      listStatus.textContent = "";
      cachedQuizzes.forEach(renderQuizRow);
    } catch (err) {
      console.error(err);
      listStatus.textContent = "一覧の取得に失敗しました";
    }
  }

  function renderQuizRow(quiz) {
    const row = document.createElement("div");
    row.className = "quiz-item";
    row.dataset.quizId = quiz.id;

    /* 左：問題＋メタ */
    const main = document.createElement("div");
    main.className = "quiz-main";

    const title = document.createElement("div");
    title.className = "quiz-title";
    title.textContent = `#${quiz.id} ${quiz.question}`;
    main.appendChild(title);

    const meta = document.createElement("div");
    meta.className = "quiz-meta";

    const att = document.createElement("span");
    att.textContent = `解答回数: ${quiz.attempts ?? 0}`;
    meta.appendChild(att);

    const statusChip = document.createElement("span");
    statusChip.className = "chip";
    if (quiz.last_correct === true) {
      statusChip.classList.add("chip-status-ok");
      statusChip.textContent = "直近正解";
    } else if (quiz.attempts > 0) {
      statusChip.classList.add("chip-status-warn");
      statusChip.textContent = "直近不正解";
    } else {
      statusChip.textContent = "未回答";
    }
    meta.appendChild(statusChip);

    main.appendChild(meta);
    row.appendChild(main);

    /* 中：回答エリア */
    const answerBox = document.createElement("div");
    answerBox.className = "quiz-answer";

    const answerInput = document.createElement("input");
    answerInput.type = "text";
    answerInput.placeholder = "ここに答えを入力";
    answerBox.appendChild(answerInput);

    const judgeBtn = document.createElement("button");
    judgeBtn.type = "button";
    judgeBtn.className = "btn btn-soft";
    judgeBtn.textContent = "判定";

    const resultSpan = document.createElement("span");
    resultSpan.className = "msg";

    judgeBtn.addEventListener("click", async () => {
      const userAns = answerInput.value.trim();
      if (!userAns) {
        resultSpan.textContent = "答えを入力してください";
        return;
      }
      resultSpan.textContent = "判定中…";

      try {
        const body = {
          answer: userAns,
          image_shown: !!row.querySelector("img.img-thumb[src]"),
        };
        const res = await fetch(`${API_BASE}/quiz/${quiz.id}/answer`, {
          method: "POST",
          headers: buildHeaders(),
          body: JSON.stringify(body),
        });
        if (!res.ok) {
          const t = await res.text();
          throw new Error(t || `HTTP ${res.status}`);
        }
        const data = await res.json();
        if (data.correct) {
          resultSpan.textContent = "⭕ 正解！";
        } else {
          resultSpan.textContent = `❌ 不正解… 正解: ${quiz.answer}`;
        }
        // ステータス更新のため軽く再取得
        setTimeout(loadQuizList, 600);
      } catch (err) {
        console.error(err);
        resultSpan.textContent = "判定に失敗しました";
      }
    });

    const answerActionRow = document.createElement("div");
    answerActionRow.style.display = "flex";
    answerActionRow.style.justifyContent = "space-between";
    answerActionRow.style.alignItems = "center";
    answerActionRow.appendChild(judgeBtn);
    answerActionRow.appendChild(resultSpan);

    answerBox.appendChild(answerActionRow);
    row.appendChild(answerBox);

    /* 右：画像＋操作 */
    const actionCol = document.createElement("div");
    actionCol.className = "quiz-actions";

    const imgWrapper = document.createElement("div");
    const img = document.createElement("img");
    img.className = "img-thumb";
    img.style.display = "none";
    img.alt = "生成画像";

    const placeholder = document.createElement("div");
    placeholder.className = "img-placeholder";
    placeholder.textContent = "画像なし";

    imgWrapper.appendChild(img);
    imgWrapper.appendChild(placeholder);
    actionCol.appendChild(imgWrapper);

    const imgBtn = document.createElement("button");
    imgBtn.type = "button";
    imgBtn.className = "btn btn-soft";
    imgBtn.textContent = "画像生成 / 再生成";

    imgBtn.addEventListener("click", async () => {
      imgBtn.disabled = true;
      imgBtn.textContent = "生成中…";
      try {
        const body = { quiz_id: quiz.id };
        const res = await fetch(`${API_BASE}/quiz/image/generate`, {
          method: "POST",
          headers: buildHeaders(),
          body: JSON.stringify(body),
        });
        if (!res.ok) {
          const t = await res.text();
          throw new Error(t || `HTTP ${res.status}`);
        }
        // 成功したら最新画像を取得
        await refreshQuizImage(quiz.id, img, placeholder);
        imgBtn.textContent = "画像生成 / 再生成";
      } catch (err) {
        console.error(err);
        imgBtn.textContent = "エラー（再試行）";
      } finally {
        imgBtn.disabled = false;
      }
    });

    const deleteBtn = document.createElement("button");
    deleteBtn.type = "button";
    deleteBtn.className = "btn btn-danger";
    deleteBtn.textContent = "削除";

    deleteBtn.addEventListener("click", async () => {
      if (!confirm("このクイズを削除しますか？")) return;
      deleteBtn.disabled = true;
      try {
        const res = await fetch(`${API_BASE}/quiz/${quiz.id}`, {
          method: "DELETE",
          headers: buildHeaders(),
        });
        if (!res.ok) {
          const t = await res.text();
          throw new Error(t || `HTTP ${res.status}`);
        }
        row.remove();
      } catch (err) {
        console.error(err);
        deleteBtn.disabled = false;
        alert("削除に失敗しました");
      }
    });

    actionCol.appendChild(imgBtn);
    actionCol.appendChild(deleteBtn);

    row.appendChild(actionCol);
    listContainer.appendChild(row);

    // 初期表示の画像取得
    refreshQuizImage(quiz.id, img, placeholder);
  }

  async function refreshQuizImage(quizId, imgEl, placeholder) {
    try {
      const res = await fetch(`${API_BASE}/quiz/${quizId}/images/latest`, {
        headers: buildHeaders(),
      });
      if (res.status === 404) {
        imgEl.style.display = "none";
        placeholder.style.display = "flex";
        return;
      }
      if (!res.ok) {
        throw new Error(`HTTP ${res.status}`);
      }
      const data = await res.json();
      if (data && data.url) {
        const url = data.url.startsWith("http")
          ? data.url
          : `${API_BASE}${data.url}`;
        imgEl.src = url;
        imgEl.style.display = "block";
        placeholder.style.display = "none";
      }
    } catch (err) {
      console.error("画像取得エラー", err);
    }
  }

  if (reloadListBtn) reloadListBtn.addEventListener("click", loadQuizList);
  if (filterSelect) filterSelect.addEventListener("change", loadQuizList);

  /* ---- スライド表示 ---- */

  const slideQuestion = document.getElementById("slide-question");
  const slideAnswer = document.getElementById("slide-answer");
  const slideImage = document.getElementById("slide-image");
  const slideIndex = document.getElementById("slide-index");
  const slideToggleBtn = document.getElementById("slide-toggle-answer");
  const slideNextBtn = document.getElementById("slide-next");
  const slideStatus = document.getElementById("slide-status");

  let slideCursor = 0;
  let slideReady = false;

  async function ensureSlidesLoaded() {
    if (cachedQuizzes.length === 0) {
      await loadQuizList();
    }
    if (cachedQuizzes.length === 0) {
      slideStatus.textContent = "表示できるクイズがありません。";
      slideReady = false;
      return;
    }
    slideReady = true;
    slideCursor = 0;
    renderSlide();
  }

  async function renderSlide() {
    if (!slideReady || cachedQuizzes.length === 0) return;
    const q = cachedQuizzes[slideCursor];

    slideQuestion.textContent = q.question;
    slideAnswer.textContent = q.answer;
    slideAnswer.style.display = "none";
    slideToggleBtn.textContent = "答えを表示";
    slideIndex.textContent = `#${q.id}  (${slideCursor + 1} / ${cachedQuizzes.length})`;

    slideImage.style.display = "none";
    slideImage.removeAttribute("src");

    // 画像取得
    try {
      const res = await fetch(`${API_BASE}/quiz/${q.id}/images/latest`, {
        headers: buildHeaders(),
      });
      if (res.ok) {
        const data = await res.json();
        if (data && data.url) {
          const url = data.url.startsWith("http")
            ? data.url
            : `${API_BASE}${data.url}`;
          slideImage.src = url;
          slideImage.style.display = "block";
        }
      }
    } catch (err) {
      console.error(err);
    }
  }

  if (slideToggleBtn) {
    slideToggleBtn.addEventListener("click", () => {
      if (!slideReady) return;
      const visible = slideAnswer.style.display === "block";
      slideAnswer.style.display = visible ? "none" : "block";
      slideToggleBtn.textContent = visible ? "答えを表示" : "答えを隠す";
    });
  }

  if (slideNextBtn) {
    slideNextBtn.addEventListener("click", () => {
      if (!slideReady || cachedQuizzes.length === 0) return;
      slideCursor = (slideCursor + 1) % cachedQuizzes.length;
      renderSlide();
    });
  }

})();
</script>
</body>
</html>
