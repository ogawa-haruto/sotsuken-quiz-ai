<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>自己生成クイズ × 画像付き単語帳（実験版）</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <style>
    body{margin:0;background:#f7f9fc;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans JP",Meiryo,sans-serif}
    header{background:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%);color:#fff;padding:18px 16px}
    h1{margin:0;font-size:20px}
    main{max-width:1000px;margin:18px auto;padding:0 12px}
    .card{background:#fff;border:1px solid #e9eef5;border-radius:12px;padding:14px 14px;margin-bottom:14px;box-shadow:0 6px 20px rgba(0,0,0,.06)}
    textarea,input,button{font-size:15px}
    textarea,input{width:100%;padding:8px;border:1px solid #dbe3ef;border-radius:8px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{padding:8px 12px;border:0;border-radius:8px;cursor:pointer;color:#fff;background:#5aa8ff}
    .btn.secondary{background:#8e92ff}
    .btn.warn{background:#ff7b6e}
    .btn.ghost{background:#fff;color:#5aa8ff;border:1px solid #5aa8ff}
    .right{margin-left:auto}
    .list{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px}
    .item{border:1px solid #e9eef5;border-radius:10px;padding:12px;background:#fff}
    .muted{color:#6b7280}
    .thumb{width:100%;max-height:200px;object-fit:cover;border-radius:8px;border:1px solid #e9eef5;margin-top:8px}
    .toolbar{display:flex;align-items:center;gap:10px;margin-bottom:8px}
    .switch{display:inline-flex;align-items:center;gap:6px}
  </style>
</head>
<body>
  <header><h1>自己生成クイズ × 画像付き単語帳（実験版）</h1></header>
  <main>
    <section class="card">
      <h2 style="margin-top:4px">クイズ作成</h2>
      <label>問題文：</label>
      <textarea id="q" rows="3" placeholder="例）apple の日本語は？" required></textarea>
      <label>答え：</label>
      <input id="a" placeholder="例）りんご" required>
      <div class="row" style="margin-top:8px">
        <button class="btn" id="saveBtn">保存</button>
        <span id="saveMsg" class="muted"></span>
        <div class="right switch">
          <input type="checkbox" id="toggleImages" checked>
          <label for="toggleImages">画像を表示</label>
        </div>
      </div>
    </section>

    <section class="card">
      <div class="toolbar">
        <h2 style="margin:0">あなたのクイズ一覧</h2>
        <div class="right">
          <button class="btn ghost" id="reloadBtn">再読み込み</button>
        </div>
      </div>
      <div id="list" class="list"><p class="muted">読み込み中...</p></div>
    </section>
  </main>

  <script>
    const API_BASE = window.location.origin;
    const tokenKey = "quiz_user_token";
    const imgToggle = document.getElementById('toggleImages');

    // X-Token付き fetch
    async function fetchWithToken(url, options = {}) {
      const headers = new Headers(options.headers || {});
      const token = localStorage.getItem(tokenKey);
      if (token) headers.set("X-Token", token);
      const res = await fetch(url, { ...options, headers });
      const issued = res.headers.get("X-Token-Issued");
      if (issued) localStorage.setItem(tokenKey, issued);
      return res;
    }
    const api = {
      j: async (r)=>{ if(!r.ok){ throw new Error(await r.text() || r.statusText) } return r.json() },
      createQuiz: (question,answer)=> fetchWithToken(`${API_BASE}/quiz/create`,{
        method:"POST", headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({question, answer})
      }).then(api.j),
      listQuizzes: ()=> fetchWithToken(`${API_BASE}/quiz/list`).then(api.j),
      latestImage: (quizId)=> fetchWithToken(`${API_BASE}/quiz/${quizId}/images/latest`).then(r=> r.status===200 ? r.json() : null),
      genImage: (quizId, {prompt=null, force=false}={})=> fetchWithToken(`${API_BASE}/quiz/image/generate?force=${force}`, {
        method:"POST", headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ quiz_id: quizId, prompt })
      }).then(api.j),
      deleteQuiz: (quizId)=> fetchWithToken(`${API_BASE}/quiz/${quizId}`, { method:"DELETE" })
    };

    // 生成中インジケータ
    function progressBar(){
      const bar = document.createElement('div');
      bar.className = 'muted';
      bar.textContent = '生成中...';
      return bar;
    }

    async function refreshList(){
      const wrap = document.getElementById('list');
      wrap.innerHTML = '<p class="muted">読み込み中...</p>';
      try{
        const items = await api.listQuizzes();
        if(!items.length){ wrap.innerHTML = '<p class="muted">まだクイズがありません。</p>'; return; }
        wrap.innerHTML = '';
        for(const q of items){
          const card = document.createElement('div');
          card.className = 'item';
          card.innerHTML = `
            <div><b>Q.</b> ${escapeHtml(q.question)}</div>
            <div><b>A.</b> ${escapeHtml(q.answer)}</div>
            <small class="muted">${new Date(q.created_at).toLocaleString()}</small>
            <div class="row" style="margin-top:8px">
              <button class="btn secondary" data-act="gen" data-id="${q.id}">画像生成</button>
              <button class="btn" data-act="regen" data-id="${q.id}">再生成（旧画像削除）</button>
              <button class="btn warn right" data-act="del" data-id="${q.id}">削除</button>
            </div>
            <div class="img-slot"></div>
          `;
          wrap.appendChild(card);

          // 最新画像があれば表示
          if(imgToggle.checked){
            try{
              const latest = await api.latestImage(q.id);
              if(latest && latest.file_path){
                const img = document.createElement('img');
                img.className = 'thumb';
                img.src = `${API_BASE}/${latest.file_path}`;
                img.alt = 'generated';
                card.querySelector('.img-slot').appendChild(img);
              }
            }catch{}
          }
        }
      }catch(e){
        wrap.innerHTML = `<p class="muted">取得失敗：${escapeHtml(e.message)}</p>`;
      }
    }

    // ボタンクリック（イベント委譲）
    document.getElementById('list').addEventListener('click', async (ev)=>{
      const btn = ev.target.closest('button[data-act]');
      if(!btn) return;
      const act = btn.getAttribute('data-act');
      const id = Number(btn.getAttribute('data-id'));
      const slot = btn.closest('.item').querySelector('.img-slot');

      if(act === 'gen' || act === 'regen'){
        const force = (act === 'regen');
        slot.innerHTML = '';
        const p = progressBar();
        slot.appendChild(p);
        try{
          const res = await api.genImage(id, {prompt:null, force});
          // 新しい画像を表示
          slot.innerHTML = '';
          if(imgToggle.checked){
            const img = document.createElement('img');
            img.className = 'thumb';
            img.src = `${API_BASE}/${res.file_path}?t=${Date.now()}`;
            img.alt = 'generated';
            slot.appendChild(img);
          }else{
            slot.innerHTML = '<span class="muted">画像は非表示設定です（上部トグルで切替）</span>';
          }
        }catch(e){
          slot.innerHTML = `<span class="muted">生成失敗：${escapeHtml(e.message)}</span>`;
        }
      }

      if(act === 'del'){
        if(!confirm('このクイズを削除しますか？（画像レコードも削除されます）')) return;
        try{
          const r = await api.deleteQuiz(id);
          if(!r.ok && r.status !== 204) throw new Error('削除に失敗しました');
          await refreshList();
        }catch(e){
          alert('削除エラー：' + e.message);
        }
      }
    });

    // 画像表示トグル
    document.getElementById('toggleImages').addEventListener('change', refreshList);
    document.getElementById('reloadBtn').addEventListener('click', refreshList);

    // 保存
    document.getElementById('saveBtn').addEventListener('click', async ()=>{
      const q = document.getElementById('q').value.trim();
      const a = document.getElementById('a').value.trim();
      if(!q || !a) return alert('問題文と答えは必須です。');
      try{
        const saved = await api.createQuiz(q,a);
        document.getElementById('q').value = '';
        document.getElementById('a').value = '';
        document.getElementById('saveMsg').textContent = `保存しました（ID:${saved.id}）`;
        await refreshList();
      }catch(e){
        alert('保存失敗：' + e.message);
      }
    });

    // HTMLエスケープ
    function escapeHtml(s){ return s.replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }

    // 初期読み込み：自分のクイズだけ表示
    window.addEventListener('DOMContentLoaded', refreshList);
  </script>
</body>
</html>
