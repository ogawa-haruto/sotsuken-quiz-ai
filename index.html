<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>クイズ学習ツール</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background-color: #f5f7fb;
      color: #222;
    }
    .app-container {
      max-width: 960px;
      margin: 0 auto;
      padding: 24px 16px 40px;
    }
    h1 {
      margin: 0 0 24px;
      font-size: 24px;
      font-weight: 700;
    }
    /* タブ */
    .tabs {
      display: flex;
      background-color: #e5e7f0;
      border-radius: 30px;
      padding: 4px;
      margin-bottom: 24px;
    }
    .tab {
      flex: 1;
      text-align: center;
      padding: 10px 4px;
      border-radius: 26px;
      font-size: 14px;
      cursor: pointer;
      user-select: none;
      transition: background-color 0.15s, color 0.15s;
    }
    .tab.active {
      background-color: #1d73e8;
      color: #fff;
      font-weight: 600;
    }

    /* 共通フォーム */
    label {
      font-size: 13px;
      margin-bottom: 4px;
      display: block;
    }
    input[type="text"],
    textarea,
    select {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #cbd3e3;
      font-size: 14px;
    }
    textarea {
      resize: vertical;
      min-height: 60px;
    }
    .row {
      display: flex;
      gap: 12px;
    }
    .row > * {
      flex: 1;
    }

    /* ボタン */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 8px 16px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 14px;
      gap: 6px;
      white-space: nowrap;
    }
    .btn-primary {
      background-color: #1d73e8;
      color: #fff;
    }
    .btn-secondary {
      background-color: #e5ecff;
      color: #1d3f8f;
    }
    .btn-danger {
      background-color: #ffd9de;
      color: #b3261e;
    }
    .btn:disabled {
      opacity: 0.6;
      cursor: default;
    }

    /* セクション共通 */
    section {
      background-color: #fff;
      border-radius: 18px;
      padding: 18px 18px 20px;
      box-shadow: 0 2px 8px rgba(15, 23, 42, 0.08);
    }
    section + section {
      margin-top: 20px;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .section-title {
      font-size: 16px;
      font-weight: 600;
    }

    /* クイズ作成 */
    .field-group {
      margin-bottom: 14px;
    }

    /* 単語帳（一覧） */
    .toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 10px;
    }
    .toolbar-left {
      flex: 1;
    }
    .toolbar-right {
      flex-shrink: 0;
    }

    .quiz-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 8px;
    }
    .quiz-card {
      background-color: #f8f9ff;
      border-radius: 14px;
      padding: 10px 12px 12px;
      border: 1px solid #e0e4f2;
    }
    .quiz-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .quiz-title {
      font-weight: 600;
      font-size: 15px;
    }
    .badge-row {
      display: flex;
      gap: 6px;
      align-items: center;
      font-size: 11px;
    }
    .badge {
      padding: 3px 8px;
      border-radius: 999px;
      background-color: #e5edff;
      color: #1d3f8f;
    }
    .badge-muted {
      background-color: #eceff4;
      color: #4b5563;
    }
    .answer-row {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 8px;
    }
    .answer-row input[type="text"] {
      flex: 1;
    }

    .quiz-image-area {
      margin-top: 4px;
      font-size: 12px;
      color: #4b5563;
    }
    .quiz-image-placeholder {
      padding: 4px 0;
    }
    .quiz-image-wrapper {
      margin-top: 4px;
    }
    .quiz-image-wrapper img {
      max-width: 100%;
      border-radius: 8px;
      border: 1px solid #e0e4f2;
      display: block;
    }
    .message {
      font-size: 13px;
      color: #4b5563;
      margin-top: 4px;
    }
    .message.error {
      color: #b3261e;
    }
    .message.success {
      color: #0f766e;
    }

    /* 単語帳（スライド） */
    .slide-container {
      text-align: center;
    }
    .slide-word {
      font-size: 40px;
      font-weight: 700;
      margin: 40px 0 10px;
    }
    .slide-answer {
      font-size: 22px;
      margin-bottom: 20px;
      color: #4b5563;
    }
    .slide-controls {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-top: 10px;
    }
  </style>
</head>
<body>
<div class="app-container">
  <h1>クイズ学習ツール</h1>

  <div class="tabs" id="tabs">
    <div class="tab active" data-tab="create">クイズ作成</div>
    <div class="tab" data-tab="list">単語帳（一覧）</div>
    <div class="tab" data-tab="slide">単語帳（スライド）</div>
  </div>

  <!-- クイズ作成 -->
  <section id="tab-create">
    <div class="section-header">
      <div class="section-title">クイズ作成</div>
    </div>

    <div class="field-group">
      <label for="question-input">問題文</label>
      <textarea id="question-input" placeholder="例）appleの日本語は？"></textarea>
    </div>

    <div class="field-group">
      <label for="answer-input">答え</label>
      <input type="text" id="answer-input" placeholder="例）りんご" />
    </div>

    <div class="field-group">
      <label for="prompt-input">画像生成用プロンプト（省略可 / 今は使わなくてもOK）</label>
      <textarea id="prompt-input" placeholder="プロンプトを指定しない場合は、サーバ側のデフォルトが使われます。"></textarea>
    </div>

    <button id="create-quiz-button" class="btn btn-primary">クイズを作成</button>
    <div id="create-message" class="message"></div>
  </section>

  <!-- 単語帳（一覧） -->
  <section id="tab-list" style="display:none;">
    <div class="section-header">
      <div class="section-title">単語帳（一覧）</div>
    </div>

    <div class="toolbar">
      <div class="toolbar-left">
        <label for="filter-select">対象</label>
        <select id="filter-select">
          <option value="all">すべて</option>
          <option value="unanswered">未回答のみ</option>
          <option value="incorrect">間違えたもの</option>
          <option value="correct_recent">直近正解</option>
        </select>
      </div>
      <div class="toolbar-right">
        <button id="reload-list-button" class="btn btn-secondary">再読み込み</button>
      </div>
    </div>

    <div class="message" id="list-message"></div>
    <div class="quiz-list" id="quiz-list"></div>
  </section>

  <!-- 単語帳（スライド） -->
  <section id="tab-slide" style="display:none;">
    <div class="section-header">
      <div class="section-title">単語帳（スライド）</div>
    </div>

    <div class="slide-container">
      <div id="slide-word" class="slide-word">–</div>
      <div id="slide-answer" class="slide-answer">答えを表示するには「答えを見る」をクリック</div>

      <div class="slide-controls">
        <button id="slide-prev" class="btn btn-secondary">前へ</button>
        <button id="slide-show-answer" class="btn btn-primary">答えを見る</button>
        <button id="slide-next" class="btn btn-secondary">次へ</button>
      </div>
    </div>
  </section>
</div>

<script>
  window.addEventListener("DOMContentLoaded", () => {
    // ==== 設定 ====
    const API_BASE_URL = location.origin; // Render / ローカル共通
    const X_TOKEN_VALUE = "dev-token";    // 自分の X-Token の値に書き換える

    const JSON_HEADERS = {
      "Content-Type": "application/json",
      "X-Token": X_TOKEN_VALUE,
    };

    async function apiFetch(path, options = {}) {
      const url = API_BASE_URL + path;
      const merged = {
        ...options,
        headers: {
          ...JSON_HEADERS,
          ...(options.headers || {}),
        },
      };
      const res = await fetch(url, merged);
      if (!res.ok) {
        const text = await res.text().catch(() => "");
        throw new Error(`API error ${res.status}: ${url} - ${text}`);
      }
      return res;
    }

    // ==== タブ切り替え ====
    const tabsEl = document.getElementById("tabs");
    const tabElems = tabsEl.querySelectorAll(".tab");
    const tabPanels = {
      create: document.getElementById("tab-create"),
      list: document.getElementById("tab-list"),
      slide: document.getElementById("tab-slide"),
    };

    tabElems.forEach((tab) => {
      tab.addEventListener("click", () => {
        const name = tab.dataset.tab;
        tabElems.forEach((t) => t.classList.toggle("active", t === tab));
        Object.entries(tabPanels).forEach(([key, panel]) => {
          panel.style.display = key === name ? "" : "none";
        });
      });
    });

    // ==== クイズ作成 ====
    const questionInput = document.getElementById("question-input");
    const answerInput = document.getElementById("answer-input");
    const promptInput = document.getElementById("prompt-input");
    const createBtn = document.getElementById("create-quiz-button");
    const createMessage = document.getElementById("create-message");

    createBtn.addEventListener("click", async () => {
      const question = questionInput.value.trim();
      const answer = answerInput.value.trim();
      const prompt = promptInput.value.trim();

      createMessage.textContent = "";
      createMessage.className = "message";

      if (!question || !answer) {
        createMessage.textContent = "問題文と答えは必須です。";
        createMessage.classList.add("error");
        return;
      }

      createBtn.disabled = true;
      try {
        const body = { question, answer };
        if (prompt) body.prompt = prompt;

        const res = await apiFetch("/quiz/create", {
          method: "POST",
          body: JSON.stringify(body),
        });
        const data = await res.json();

        createMessage.textContent = "クイズを作成しました。（ID: " + data.id + "）";
        createMessage.classList.add("success");
        questionInput.value = "";
        answerInput.value = "";
        // prompt はそのまま残す
        loadQuizList(); // 一覧を更新
      } catch (err) {
        console.error(err);
        createMessage.textContent = "クイズ作成中にエラーが発生しました。";
        createMessage.classList.add("error");
      } finally {
        createBtn.disabled = false;
      }
    });

    // ==== 単語帳（一覧） ====
    const filterSelect = document.getElementById("filter-select");
    const reloadListBtn = document.getElementById("reload-list-button");
    const listMessage = document.getElementById("list-message");
    const quizListEl = document.getElementById("quiz-list");

    reloadListBtn.addEventListener("click", () => {
      loadQuizList();
    });

    filterSelect.addEventListener("change", () => {
      loadQuizList();
    });

    async function loadQuizList() {
      listMessage.textContent = "読込中…";
      listMessage.className = "message";

      try {
        const status = filterSelect.value;
        const params = new URLSearchParams({ status });
        const res = await apiFetch("/quiz/list?" + params.toString());
        const quizzes = await res.json();

        quizListEl.innerHTML = "";
        if (!quizzes.length) {
          listMessage.textContent = "クイズがまだありません。";
          return;
        }
        listMessage.textContent = "";

        quizzes.forEach((quiz) => {
          const card = createQuizCard(quiz);
          quizListEl.appendChild(card);
          loadLatestImageForCard(quiz.id, card, false);
        });
      } catch (err) {
        console.error(err);
        listMessage.textContent = "一覧の取得中にエラーが発生しました。";
        listMessage.classList.add("error");
      }
    }

    function createQuizCard(quiz) {
      const card = document.createElement("div");
      card.className = "quiz-card";
      card.dataset.quizId = String(quiz.id);

      const header = document.createElement("div");
      header.className = "quiz-card-header";

      const title = document.createElement("div");
      title.className = "quiz-title";
      title.textContent = `#${quiz.id} ${quiz.question}`;

      const badgeRow = document.createElement("div");
      badgeRow.className = "badge-row";

      const statusBadge = document.createElement("span");
      statusBadge.className = "badge";
      const statusMap = {
        unanswered: "未回答",
        incorrect: "誤答あり",
        correct_recent: "直近正解",
        correct_old: "過去に正解",
      };
      statusBadge.textContent = statusMap[quiz.status] || quiz.status || "状態不明";

      const attemptsBadge = document.createElement("span");
      attemptsBadge.className = "badge badge-muted";
      attemptsBadge.textContent = `解答回数: ${quiz.attempts ?? 0}`;

      badgeRow.appendChild(statusBadge);
      badgeRow.appendChild(attemptsBadge);

      header.appendChild(title);
      header.appendChild(badgeRow);
      card.appendChild(header);

      // 回答欄
      const answerRow = document.createElement("div");
      answerRow.className = "answer-row";

      const answerInput = document.createElement("input");
      answerInput.type = "text";
      answerInput.placeholder = "ここに答えを入力";

      const imageBtn = document.createElement("button");
      imageBtn.className = "btn btn-secondary";
      imageBtn.textContent = "画像生成 / 再生成";

      const judgeBtn = document.createElement("button");
      judgeBtn.className = "btn btn-primary";
      judgeBtn.textContent = "判定";

      const deleteBtn = document.createElement("button");
      deleteBtn.className = "btn btn-danger";
      deleteBtn.textContent = "削除";

      answerRow.appendChild(answerInput);
      answerRow.appendChild(imageBtn);
      answerRow.appendChild(judgeBtn);
      answerRow.appendChild(deleteBtn);

      card.appendChild(answerRow);

      // 画像エリア
      const imageArea = document.createElement("div");
      imageArea.className = "quiz-image-area";

      const imagePlaceholder = document.createElement("div");
      imagePlaceholder.className = "quiz-image-placeholder";
      imagePlaceholder.textContent = "画像はまだ生成されていません。";

      const imageWrapper = document.createElement("div");
      imageWrapper.className = "quiz-image-wrapper";
      const imageEl = document.createElement("img");
      imageEl.style.display = "none";

      imageWrapper.appendChild(imageEl);
      imageArea.appendChild(imagePlaceholder);
      imageArea.appendChild(imageWrapper);

      card.appendChild(imageArea);

      const msg = document.createElement("div");
      msg.className = "message";
      card.appendChild(msg);

      // イベント
      imageBtn.addEventListener("click", async () => {
        msg.textContent = "画像を生成中…";
        msg.className = "message";
        imageBtn.disabled = true;
        try {
          await apiFetch("/quiz/image/generate", {
            method: "POST",
            body: JSON.stringify({ quiz_id: quiz.id }),
          });
          msg.textContent = "画像の生成リクエストを送信しました。";
          msg.classList.add("success");
          await loadLatestImageForCard(quiz.id, card, true);
        } catch (err) {
          console.error(err);
          msg.textContent = "画像生成中にエラーが発生しました。";
          msg.classList.add("error");
        } finally {
          imageBtn.disabled = false;
        }
      });

      judgeBtn.addEventListener("click", async () => {
        const answer = answerInput.value.trim();
        msg.textContent = "";
        msg.className = "message";

        if (!answer) {
          msg.textContent = "答えを入力してください。";
          msg.classList.add("error");
          return;
        }

        judgeBtn.disabled = true;
        try {
          const res = await apiFetch(`/quiz/${quiz.id}/answer`, {
            method: "POST",
            body: JSON.stringify({ answer, image_shown: imageEl.style.display !== "none" }),
          });
          const data = await res.json();
          msg.textContent = data.correct ? "正解！" : "不正解…。";
          msg.classList.add(data.correct ? "success" : "error");

          // 再読込してバッジ更新
          loadQuizList();
        } catch (err) {
          console.error(err);
          msg.textContent = "判定中にエラーが発生しました。";
          msg.classList.add("error");
        } finally {
          judgeBtn.disabled = false;
        }
      });

      deleteBtn.addEventListener("click", async () => {
        if (!confirm("このクイズを削除しますか？")) return;
        deleteBtn.disabled = true;
        try {
          await apiFetch(`/quiz/${quiz.id}`, { method: "DELETE" });
          quizListEl.removeChild(card);
        } catch (err) {
          console.error(err);
          msg.textContent = "削除中にエラーが発生しました。";
          msg.classList.add("error");
          deleteBtn.disabled = false;
        }
      });

      return card;
    }

    // 画像取得
    async function loadLatestImageForCard(quizId, card, forceReload) {
      const placeholder = card.querySelector(".quiz-image-placeholder");
      const img = card.querySelector(".quiz-image-wrapper img");

      if (!placeholder || !img) return;

      try {
        const url = API_BASE_URL + `/quiz/${quizId}/images/latest`;
        const res = await fetch(url, {
          headers: {
            "X-Token": X_TOKEN_VALUE,
          },
        });

        if (res.status === 404) {
          // まだ画像なし
          placeholder.style.display = "";
          placeholder.textContent = "画像はまだ生成されていません。";
          img.style.display = "none";
          return;
        }

        if (!res.ok) {
          throw new Error("status " + res.status);
        }

        const data = await res.json();

        // サーバ側のフィールド名に柔軟に対応
        let rawUrl =
          data.url ||
          data.image_url ||
          data.path ||
          data.imagePath ||
          data.image_path ||
          data.file_path ||   // ★これを追加
          "";

        if (!rawUrl) {
          placeholder.style.display = "";
          placeholder.textContent = "画像の URL を取得できませんでした。";
          img.style.display = "none";
          return;
        }

        let fullUrl = rawUrl;
        if (!/^https?:\/\//i.test(rawUrl)) {
          // 相対パスなら API_BASE_URL を付ける
          fullUrl = API_BASE_URL + rawUrl;
        }

        if (forceReload) {
          // キャッシュされないようにクエリを付ける
          const sep = fullUrl.includes("?") ? "&" : "?";
          fullUrl = fullUrl + sep + "t=" + Date.now();
        }

        img.src = fullUrl;
        img.alt = "generated image for quiz " + quizId;
        img.style.display = "block";
        placeholder.style.display = "none";
      } catch (err) {
        console.error(err);
        placeholder.style.display = "";
        placeholder.textContent = "画像の取得中にエラーが発生しました。";
        img.style.display = "none";
      }
    }

    // ==== スライドモード（すごくシンプルに） ====
    const slideWordEl = document.getElementById("slide-word");
    const slideAnswerEl = document.getElementById("slide-answer");
    const slidePrevBtn = document.getElementById("slide-prev");
    const slideNextBtn = document.getElementById("slide-next");
    const slideShowAnswerBtn = document.getElementById("slide-show-answer");

    let slideQuizzes = [];
    let slideIndex = 0;
    let slideShowAnswer = false;

    async function loadSlideQuizzes() {
      try {
        const res = await apiFetch("/quiz/list?status=all&limit=200");
        slideQuizzes = await res.json();
        slideIndex = 0;
        slideShowAnswer = false;
        updateSlideView();
      } catch (err) {
        console.error(err);
      }
    }

    function updateSlideView() {
      if (!slideQuizzes.length) {
        slideWordEl.textContent = "クイズがありません。";
        slideAnswerEl.textContent = "";
        return;
      }
      const q = slideQuizzes[slideIndex];
      slideWordEl.textContent = q.question;
      slideAnswerEl.textContent = slideShowAnswer ? `答え：${q.answer}` : "答えを表示するには「答えを見る」をクリック";
    }

    slidePrevBtn.addEventListener("click", () => {
      if (!slideQuizzes.length) return;
      slideIndex = (slideIndex - 1 + slideQuizzes.length) % slideQuizzes.length;
      slideShowAnswer = false;
      updateSlideView();
    });

    slideNextBtn.addEventListener("click", () => {
      if (!slideQuizzes.length) return;
      slideIndex = (slideIndex + 1) % slideQuizzes.length;
      slideShowAnswer = false;
      updateSlideView();
    });

    slideShowAnswerBtn.addEventListener("click", () => {
      slideShowAnswer = true;
      updateSlideView();
    });

    // 初期ロード
    loadQuizList();
    loadSlideQuizzes();
  });
</script>
</body>
</html>
