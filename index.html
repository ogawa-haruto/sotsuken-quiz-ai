<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>自己生成クイズ × 単語帳（一覧＋スライド統合）</title>
  <style>
    :root{
      --bg:#f6f9fc; --card:#ffffff; --border:#e5e7eb;
      --text:#0f172a; --muted:#64748b; --brand:#0ea5e9;
      --danger:#ef4444; --ok:#10b981; --shadow:0 6px 20px rgba(2,8,23,.06);
      --radius:12px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans JP",Meiryo,sans-serif}
    header{max-width:1000px;margin:20px auto 8px;padding:0 16px}
    h1{font-size:22px;margin:0 0 8px}
    .lead{color:var(--muted);font-size:14px;line-height:1.6}
    .container{max-width:1000px;margin:8px auto 24px;padding:0 16px}
    .tabs{display:flex;gap:8px;margin:8px 0 12px}
    .tab{flex:1;border:1px solid var(--border);background:#e7eef7;color:#0b1324;border-radius:10px;padding:10px;cursor:pointer;text-align:center}
    .tab.active{background:var(--brand);color:#fff;border-color:var(--brand)}
    section.card{display:none;background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px}
    section.card.active{display:block}
    label{display:block;margin:10px 0 6px}
    textarea,input[type=text]{width:100%;padding:10px;border:1px solid #cbd5e1;border-radius:10px;background:#fff}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    button{padding:9px 12px;border-radius:10px;border:1px solid #3b82f6;background:var(--brand);color:#fff;cursor:pointer}
    button.secondary{background:#fff;color:#0f172a;border:1px solid #94a3b8}
    button.ghost{background:#fff;color:var(--brand);border:1px solid var(--brand)}
    button.warn{background:var(--danger);border-color:#dc2626}
    .muted{color:var(--muted)}
    .toolbar{display:flex;gap:10px;align-items:center;margin-bottom:8px;flex-wrap:wrap}
    .toolbar .right{margin-left:auto}

    /* 単語帳のモード切替ボタン */
    .subtabs{display:flex;gap:10px;margin-bottom:8px}
    .subbtn{flex:1;padding:10px;border-radius:16px;border:1px solid var(--border);background:#edf2f7;color:#0b1324;cursor:pointer}
    .subbtn.active{background:#0ea5e9;color:#fff;border-color:#0ea5e9}

    .list{display:grid;grid-template-columns:repeat(auto-fit,minmax(290px,1fr));gap:12px}
    .item{border:1px solid var(--border);border-radius:12px;padding:12px;background:#fff}
    .thumb{width:100%;max-height:220px;object-fit:cover;border-radius:10px;border:1px solid var(--border);margin-top:8px}

    .ansbox{display:flex;gap:8px;align-items:center;margin-top:6px}
    .ansbox input{flex:1}
    .judge{font-weight:600}
    .ok{color:var(--ok)}
    .ng{color:var(--danger)}

    .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#111827;color:#fff;padding:10px 14px;border-radius:12px;box-shadow:var(--shadow);opacity:0;pointer-events:none;transition:opacity .2s}
    .toast.show{opacity:0.95}
    .stats{display:flex;gap:16px;align-items:center;flex-wrap:wrap}
    .kpi{background:#fff;border:1px solid var(--border);border-radius:10px;padding:10px 12px;box-shadow:var(--shadow)}
    .kpi b{font-size:18px;margin-right:4px}

    /* --- Flashcards (slide) --- */
    .progress{height:8px;background:#eef2f7;border-radius:999px;overflow:hidden;margin:8px 0}
    .bar{height:100%;width:0%;background:#7aa6ff;transition:width .2s}
    .fc-wrap{display:flex;flex-direction:column;align-items:center}
    .fc-card{
      width:min(780px,96%);
      min-height:160px;
      border:1px solid var(--border);
      border-radius:16px;
      display:flex;align-items:center;justify-content:center;
      margin:18px 0; padding:24px; font-size:1.3rem;
      cursor:pointer; user-select:none; box-shadow:var(--shadow);
      background:#fff; text-align:center;
    }
    #fc-img{
      display:none; margin-top:8px; max-width:100%; height:auto; object-fit:contain;
      border-radius:12px; border:1px solid var(--border);
    }
    @keyframes slideOutLeft  { from { transform: translateX(0); }   to { transform: translateX(-40%); opacity:.2; } }
    @keyframes slideInRight  { from { transform: translateX(40%); opacity:.2; } to { transform: translateX(0); opacity:1; } }
    @keyframes slideOutRight { from { transform: translateX(0); }   to { transform: translateX(40%); opacity:.2; } }
    @keyframes slideInLeft   { from { transform: translateX(-40%); opacity:.2; } to { transform: translateX(0); opacity:1; } }
    .fc-anim { will-change: transform, opacity; }
    .fc-out-left  { animation: slideOutLeft .18s ease forwards;  }
    .fc-in-right  { animation: slideInRight .18s ease forwards;   }
    .fc-out-right { animation: slideOutRight .18s ease forwards;  }
    .fc-in-left   { animation: slideInLeft .18s ease forwards;    }
  </style>
</head>
<body>
  <header>
    <h1>自己生成クイズ × 単語帳（一覧＋スライド統合）</h1>
    <div class="lead">作成 → 単語帳。単語帳の中で「一覧 / スライド」を切り替えられます。</div>
  </header>

  <div class="container">
    <div class="tabs">
      <button id="tab-create" class="tab active">クイズ作成</button>
      <button id="tab-words" class="tab">単語帳</button>
    </div>

    <!-- 作成 -->
    <section id="create" class="card active">
      <form id="quizForm">
        <label>問題文</label>
        <textarea id="question" rows="2" placeholder="例）apple の日本語は？" required></textarea>
        <label>答え</label>
        <input id="answer" type="text" placeholder="例）りんご" required />
        <div class="row" style="margin-top:8px">
          <button type="submit">作成</button>
          <button class="secondary" type="button" id="goWords">単語帳へ</button>
          <span id="saveMsg" class="muted"></span>
        </div>
      </form>
    </section>

    <!-- 単語帳（一覧＋スライド 統合） -->
    <section id="words" class="card">
      <div class="subtabs">
        <button id="mode-list"  class="subbtn active">単語帳（一覧）</button>
        <button id="mode-slide" class="subbtn">単語帳（スライド）</button>
      </div>

      <!-- 共通ツールバー（分野/項目はどちらのモードでも使用） -->
      <div class="toolbar">
        <div class="row">
          <select id="fc-category">
            <option value="">すべての分野</option>
          </select>
          <select id="fc-topic">
            <option value="">すべての項目</option>
          </select>
        </div>
        <div class="right row">
          <!-- 一覧モード専用 -->
          <div id="list-only" class="row">
            <label class="muted">画像</label>
            <select id="imgMode">
              <option value="on" selected>表示する</option>
              <option value="off">表示しない</option>
            </select>
            <label class="muted">フィルタ</label>
            <select id="filterMode">
              <option value="all" selected>すべて</option>
              <option value="incorrect_only">未正解のみ</option>
              <option value="unanswered_only">未回答のみ</option>
            </select>
            <button class="ghost" id="reloadBtn">再読み込み</button>
          </div>

          <!-- スライド専用 -->
          <div id="slide-only" class="row" style="display:none">
            <label class="muted">順序</label>
            <label><input type="checkbox" id="fc-shuffle"> シャッフル</label>
            <label class="muted">開始</label>
            <select id="fc-limit">
              <option value="20">20枚</option>
              <option value="50" selected>50枚</option>
              <option value="100">100枚</option>
            </select>
            <label><input type="checkbox" id="fc-answer-first"> 先に答えを表示</label>
            <button class="ghost" id="fc-reload">読み込み</button>
          </div>
        </div>
      </div>

      <!-- 一覧モード本体 -->
      <div id="pane-list">
        <div class="stats" style="margin-bottom:8px">
          <div class="kpi"><b id="kpi-acc">0%</b>正解率</div>
          <div class="kpi"><b id="kpi-attempts">0</b>回答</div>
          <div class="kpi"><b id="kpi-total">0</b>問題</div>
        </div>
        <div id="quizList" class="list"><p class="muted">読み込み中...</p></div>
      </div>

      <!-- スライドモード本体 -->
      <div id="pane-slide" style="display:none">
        <div class="progress"><div class="bar" id="fc-bar"></div></div>
        <div class="fc-wrap">
          <div id="fc-card" class="fc-card">単語帳：右上の「読み込み」を押してください</div>
          <img id="fc-img" alt="" />
          <div class="row" style="margin-top:10px">
            <button id="fc-prev">← 前へ</button>
            <button id="fc-flip">裏返す</button>
            <button id="fc-next">次へ →</button>
          </div>
          <div class="muted" style="margin-top:6px">Space: 表/裏　←/→: 前後　スワイプ可</div>
        </div>
      </div>
    </section>
  </div>

  <div id="toast" class="toast">保存しました</div>

  <script>
    const API_BASE = window.location.origin;
    const $ = (s)=>document.querySelector(s);

    const ui = {
      tabCreate: $('#tab-create'),
      tabWords:  $('#tab-words'),
      secCreate: $('#create'),
      secWords:  $('#words'),
      form: $('#quizForm'),
      q: $('#question'),
      a: $('#answer'),
      saveMsg: $('#saveMsg'),
      goWords: $('#goWords'),

      // words 共通
      subList:  $('#mode-list'),
      subSlide: $('#mode-slide'),
      paneList: $('#pane-list'),
      paneSlide: $('#pane-slide'),
      bar: $('#fc-bar'),

      // 共通フィルタ
      cat: $('#fc-category'),
      top: $('#fc-topic'),

      // 一覧用
      imgMode: $('#imgMode'),
      filter:  $('#filterMode'),
      reload:  $('#reloadBtn'),
      list:    $('#quizList'),
      kpiAcc:  $('#kpi-acc'),
      kpiAtt:  $('#kpi-attempts'),
      kpiTotal:$('#kpi-total'),

      // スライド用
      sShuffle: $('#fc-shuffle'),
      sLimit:   $('#fc-limit'),
      sAnsFirst:$('#fc-answer-first'),
      sReload:  $('#fc-reload'),
      sCard:    $('#fc-card'),
      sImg:     $('#fc-img'),
      sPrev:    $('#fc-prev'),
      sNext:    $('#fc-next'),
      sFlip:    $('#fc-flip'),

      listOnly:  $('#list-only'),
      slideOnly: $('#slide-only'),
    };

    const api = {
      j: async r=>{ if(!r.ok) throw new Error(await r.text()); return r.json(); },
      create:(q,a)=>fetch(`${API_BASE}/quiz/create`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({question:q,answer:a})}).then(api.j),
      list:(status)=>fetch(`${API_BASE}/quiz/list?status=${status||'all'}`).then(api.j),
      del:id=>fetch(`${API_BASE}/quiz/${id}`,{method:'DELETE'}),
      regen:(id,prompt,force)=>fetch(`${API_BASE}/quiz/image/generate?force=${force?'true':'false'}`,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({quiz_id:id,prompt:prompt||null})
      }).then(api.j),
      latest:id=>fetch(`${API_BASE}/quiz/${id}/images/latest`).then(api.j),
      answer:(id,ans,img)=>fetch(`${API_BASE}/quiz/${id}/answer`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({answer:ans,image_shown:img})}).then(api.j),
      stats:()=>fetch(`${API_BASE}/stats/summary`).then(api.j),
    };

    function toast(m){ const t=document.getElementById('toast'); t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1300); }

    // ===== タブ切替（大タブ：作成 / 単語帳） =====
    function activate(tab){
      [ui.tabCreate, ui.tabWords].forEach(b=>b.classList.remove('active'));
      [ui.secCreate, ui.secWords].forEach(s=>s.classList.remove('active'));
      if(tab==='create'){ ui.tabCreate.classList.add('active'); ui.secCreate.classList.add('active'); }
      if(tab==='words'){  ui.tabWords.classList.add('active');  ui.secWords.classList.add('active'); renderList(); renderStats(); }
    }
    ui.tabCreate.onclick=()=>activate('create');
    ui.tabWords.onclick=()=>activate('words');
    ui.goWords.onclick=()=>activate('words');

    // ===== 作成 =====
    document.getElementById('quizForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      try{ await api.create(ui.q.value.trim(), ui.a.value.trim()); ui.q.value=''; ui.a.value=''; toast('保存しました'); }
      catch{ toast('保存に失敗'); }
    });

    // ===== 単語帳（一覧） =====
    async function renderStats(){
      try{
        const s=await api.stats();
        ui.kpiAcc.textContent=`${Math.round(s.accuracy*100)}%`;
        ui.kpiAtt.textContent=s.attempts;
        ui.kpiTotal.textContent=s.total_quizzes;
      }catch{}
    }
    async function renderList(){
      ui.list.innerHTML='<p class="muted">読み込み中...</p>';
      try{
        const rows=await api.list(ui.filter.value);
        const showImg=ui.imgMode.value==='on';
        const fr=document.createDocumentFragment();
        for(const q of rows){
          const c=document.createElement('div');
          c.className='item';
          c.innerHTML=`
            <div class="row" style="justify-content:space-between">
              <div><b>#${q.id}</b> ${q.question}</div>
              <div class="row">
                <button class="secondary" data-act="regen" data-id="${q.id}">画像生成 / 再生成</button>
                <button class="warn" data-act="del" data-id="${q.id}">削除</button>
              </div>
            </div>
            <div class="row" style="margin-top:4px">
              <input type="text"
                     placeholder="画像プロンプトを追加（任意）"
                     data-img-prompt="${q.id}" />
            </div>
            <div class="ansbox">
              <input type="text" placeholder="答えを入力" data-answer-input="${q.id}" />
              <button class="ghost" data-act="check" data-id="${q.id}">判定・記録</button>
              <span class="judge muted" data-judge="${q.id}"></span>
            </div>
            <div class="img-slot"></div>`;
          fr.appendChild(c);
          if(showImg){
            try{
              const im=await api.latest(q.id);
              if(im?.file_path){
                const img=document.createElement('img');
                img.className='thumb'; img.src=`${API_BASE}/${im.file_path}`;
                c.querySelector('.img-slot').appendChild(img);
              }
            }catch{}
          }
        }
        ui.list.innerHTML=''; ui.list.appendChild(fr);
      }catch(e){ ui.list.innerHTML=`<p class="muted">エラー: ${e.message}</p>`; }
    }

    document.addEventListener('click',async e=>{
      const b=e.target.closest('button[data-act]'); if(!b) return;
      const id=b.dataset.id, act=b.dataset.act;
      if(act==='del'){
        if(confirm('削除しますか？')){ await api.del(id); toast('削除'); await renderList(); }
      }
      if(act==='regen'){
        // 入力されている追加プロンプトを取得（空なら定型のみで生成）
        const inp=document.querySelector(`[data-img-prompt="${id}"]`);
        const extra = inp ? inp.value.trim() : '';
        try{
          await api.regen(id, extra || null, false);
          toast('画像を生成しました');
          await renderList();
        }catch(err){
          toast('画像生成に失敗しました');
        }
      }
      if(act==='check'){
        const i=document.querySelector(`[data-answer-input="${id}"]`);
        const j=document.querySelector(`[data-judge="${id}"]`);
        const ans=i.value.trim();
        const hasImg=!!document.querySelector(`.item:nth-child(${id}) img`);
        try{
          const r=await api.answer(id,ans,hasImg);
          j.textContent=r.correct?'正しい（記録）':'誤り（記録）';
          j.className='judge '+(r.correct?'ok':'ng');
          await renderStats();
        }catch{
          j.textContent='記録エラー';
          j.className='judge ng';
        }
      }
    });
    ui.reload.onclick=()=>{ renderList(); renderStats(); };
    ui.imgMode.onchange=renderList;
    ui.filter.onchange=renderList;

    // ===== 単語帳（スライド） =====
    let fcAll=[], fcCards=[], fcIdx=0, fcShowBack=false;
    function unique(arr){ return [...new Set(arr)].filter(Boolean); }
    function mapQuizzesToCards(quizzes){
      return quizzes.map(q=>({
        id:q.id, front:q.question, back:q.answer,
        category:q.category ?? q.tag ?? null,
        topic:q.topic ?? q.subtag ?? null,
        tags:q.tags ?? null,
        image_url:null
      }));
    }
    function populateFilters(cards){
      const cats = unique(cards.flatMap(c=>[c.category, ...(Array.isArray(c.tags)?c.tags:[])]));
      const tops = unique(cards.map(c=>c.topic));
      ui.cat.innerHTML = '<option value="">すべての分野</option>' + cats.map(v=>`<option value="${v}">${v}</option>`).join('');
      ui.top.innerHTML = '<option value="">すべての項目</option>' + tops.map(v=>`<option value="${v}">${v}</option>`).join('');
    }
    function applyFilter(){
      const cat=ui.cat.value, top=ui.top.value;
      fcCards = fcAll.filter(c=>{
        const okCat=!cat || c.category===cat || (Array.isArray(c.tags)&&c.tags.includes(cat));
        const okTop=!top || c.topic===top;
        return okCat && okTop;
      });
      fcIdx=0; renderSlide();
    }
    function updateBar(){
      ui.bar.style.width = fcCards.length ? Math.round(((fcIdx+1)/fcCards.length)*100)+'%' : '0%';
    }
    function adjustImg(){
      if($('#words').style.display==='none') return;
      const topToolbar = 200, bottomControls = 150, margin = 24;
      const avail = Math.max(160, window.innerHeight - topToolbar - bottomControls - margin);
      ui.sImg.style.maxHeight = avail + 'px';
    }
    function renderSlide(){
      if(!fcCards.length){ ui.sCard.textContent='該当データがありません'; ui.sImg.style.display='none'; updateBar(); return; }
      const c=fcCards[fcIdx];
      ui.sCard.textContent = fcShowBack ? (c.back ?? '') : (c.front ?? '');
      if(c.image_url){
        ui.sImg.onload=adjustImg; ui.sImg.src=c.image_url; ui.sImg.style.display='block';
      }else{
        if(c._img_loading!==true){
          c._img_loading=true;
          api.latest(c.id).then(im=>{
            if(im?.file_path){ c.image_url=`${API_BASE}/${im.file_path}`; renderSlide(); }
          }).catch(()=>{});
        }
        ui.sImg.style.display='none';
      }
      updateBar();
    }
    function shuffleInPlace(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } }
    function slide(change, dir){
      const card=ui.sCard, img=ui.sImg;
      const outClass = dir==='next'?'fc-out-left':'fc-out-right';
      const inClass  = dir==='next'?'fc-in-right':'fc-in-left';
      [card,img].forEach(el=>{ if(el && el.style.display!=='none'){ el.classList.add('fc-anim',outClass);} });
      function onOut(){
        change(); fcShowBack=false; renderSlide();
        [card,img].forEach(el=>{
          if(!el || el.style.display==='none') return;
          el.classList.remove(outClass); void el.offsetWidth;
          el.classList.add(inClass);
          el.addEventListener('animationend', function onIn(){ el.classList.remove('fc-anim',inClass); el.removeEventListener('animationend', onIn); }, {once:true});
        });
        card.removeEventListener('animationend', onOut);
        img && img.removeEventListener('animationend', onOut);
      }
      card.addEventListener('animationend', onOut, {once:true});
      img && img.addEventListener('animationend', onOut, {once:true});
    }
    async function loadSlide(){
      ui.sCard.textContent='読み込み中...'; ui.sImg.style.display='none';
      const limit = Number(ui.sLimit.value);
      const rows = await api.list('all');
      fcAll = mapQuizzesToCards(rows).slice(0, limit);
      if(ui.sShuffle.checked) shuffleInPlace(fcAll);
      populateFilters(fcAll);
      applyFilter();
      fcShowBack = !!ui.sAnsFirst.checked;
    }
    // 監視
    ui.sReload.onclick=loadSlide;
    ui.sFlip.onclick=()=>{ fcShowBack=!fcShowBack; renderSlide(); };
    ui.sNext.onclick=()=>{ if(fcIdx<fcCards.length-1) slide(()=>{ fcIdx++; }, 'next'); };
    ui.sPrev.onclick=()=>{ if(fcIdx>0) slide(()=>{ fcIdx--; }, 'prev'); };
    window.addEventListener('keydown', (e)=>{
      if($('#words').style.display==='none' || ui.paneSlide.style.display==='none') return;
      if(e.code==='Space'){ e.preventDefault(); fcShowBack=!fcShowBack; renderSlide(); }
      if(e.key==='ArrowRight' && fcIdx<fcCards.length-1) slide(()=>{ fcIdx++; }, 'next');
      if(e.key==='ArrowLeft'  && fcIdx>0)                slide(()=>{ fcIdx--; }, 'prev');
    });
    ui.cat.addEventListener('change', ()=>{ applyFilter(); });
    ui.top.addEventListener('change', ()=>{ applyFilter(); });
    window.addEventListener('resize', adjustImg);

    // ===== サブモード切替（一覧 / スライド） =====
    function switchMode(mode){
      [ui.subList,ui.subSlide].forEach(b=>b.classList.remove('active'));
      ui.paneList.style.display = mode==='list' ? '' : 'none';
      ui.paneSlide.style.display = mode==='slide' ? '' : 'none';
      document.getElementById('list-only').style.display  = mode==='list' ? '' : 'none';
      document.getElementById('slide-only').style.display = mode==='slide' ? '' : 'none';
      if(mode==='list'){ ui.subList.classList.add('active'); renderList(); renderStats(); }
      if(mode==='slide'){ ui.subSlide.classList.add('active'); if(!window.__slide_inited){ window.__slide_inited=true; loadSlide(); } }
    }
    ui.subList.onclick = ()=>switchMode('list');
    ui.subSlide.onclick= ()=>switchMode('slide');

    // 初期表示
    activate('create');
    ui.tabWords.addEventListener('click', ()=>switchMode('list'));
  </script>
</body>
</html>
